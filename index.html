<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lesson Store</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
  <script src="https://unpkg.com/vue@2.7.8/dist/vue.js"></script>
</head>
<body>
<div id="lessonStore" class="container">


  <!-- Header -->
  <header class="top-bar">
    <div class="logo-title">
      <img src="images\logo.png" alt="Logo" class="logo">
      <h1>TheUKAcademy</h1>
    </div>
    <button class="cart-btn" v-on:click="toggleCart" v-bind:disabled="cart.length === 0">
      <span class="fa-solid fa-cart-shopping"></span> Cart ({{ cart.length }})
    </button>
  </header>

  <!-- Search Bar -->
<div v-if="showLessons" class="search-section">
  <input 
    type="text" 
    v-model="searchQuery" 
    @input="searchLessons"
    placeholder="Search lessons..."
    class="search-input"
  >
</div>


  <!-- Sorting -->
  <div v-if="showLessons" class="sort-section">
    <label>Sort by:</label>
    <select v-model="sortBy">
      <option value="subject">Subject</option>
      <option value="location">Location</option>
      <option value="price">Price</option>
      <option value="spaces">Spaces</option>
    </select>
    <button class="sort-btn" v-on:click="toggleSortOrder">
      {{ sortOrder === 'asc' ? 'Ascending' : 'Descending' }} <i v-bind:class="sortOrderIcon"></i>
    </button>
  </div>

  <!-- Lessons List -->
  <div v-if="showLessons" class="lessons-grid">
    <div class="lesson-card" v-for="lesson in sortedLessons" v-bind:key="lesson.id">
      <i :class="lesson.icon + ' lesson-icon'"></i>
      <h3>{{ lesson.subject }}</h3>
      <p><i class="fa-solid fa-location-dot"></i> {{ lesson.location }}</p>
      <p><i class="fa-solid fa-money-bill-1-wave"></i> Price: £{{ lesson.price }}</p>
      <p><i class="fa-solid fa-users"></i> Spaces: {{ lesson.spaces }}</p>
      <button class="add-cart-btn" v-bind:disabled="lesson.spaces === 0" v-on:click="addToCart(lesson)">
        <span class="fa-solid fa-cart-plus"></span> Add to Cart
      </button>
    </div>
  </div>

  <!-- Cart Page -->
  <div v-else class="cart-page">
    <h2><i class="fa-solid fa-cart-shopping"></i> Your Cart</h2>
    
    <div v-if="!orderPlaced">
      <div v-if="cart.length > 0" class="cart-list">
        <div class="cart-item" v-for="(item, index) in cart" v-bind:key="index">
          <p><strong>{{ item.subject }}</strong> — {{ item.location }} (£{{ item.price }})</p>
          <button class="remove-btn" v-on:click="removeFromCart(index)">
            <i class="fa-solid fa-trash"></i> Remove
          </button>
        </div>

        <!-- Checkout Section -->
        <div class="checkout-section">
          <h3>Checkout Information</h3>
          <form @submit.prevent="submitOrder">
            <div class="form-group">
              <label><i class="fa-solid fa-user"></i> Name</label>
              <input type="text" v-model="customer.name" placeholder="Enter your name" required>
            </div>
            <div class="form-group">
              <label><i class="fa-solid fa-phone"></i> Phone (+44)</label>
              <input type="number" v-model="customer.phone" placeholder="Enter your phone number" required>
            </div>
            <div class="form-group">
                <label><i class="fa-solid fa-earth-europe"></i> Select Country:</label>
                <div class="radio-group">
                  <label>
                    <input type="radio" value="England" v-model="customer.country">
                    England
                  </label>
                  <label>
                    <input type="radio" value="Wales" v-model="customer.country">
                    Wales
                  </label>
                  <label>
                    <input type="radio" value="Scotland" v-model="customer.country">
                    Scotland
                  </label>
                  <label>
                    <input type="radio" value="Northern Ireland" v-model="customer.country">
                    Northern Ireland
                  </label>
                </div>
             </div>
             <div class="form-group">
              <label><i class="fa-solid fa-house"></i> Address</label>
              <input type="text" v-model="customer.address" placeholder="Enter your address" required>
            </div>
            <div class="form-group">
              <label><i class="fa-solid fa-city"></i> City</label>
              <input type="text" v-model="customer.city" placeholder="Enter your city" required>
            </div>
            <div class="form-group">
              <label><i class="fa-solid fa-envelope"></i> ZIP Code</label>
              <input type="number" v-model="customer.zip" placeholder="Enter your ZIP Code" required>
            </div>
            <button type="submit" class="checkout-btn" v-bind:disabled="!validName || !validPhone">
                <i class="fa-solid fa-credit-card"></i> Confirm Checkout
            </button>

          </form>
        </div>
      </div>

      <div v-else>
        <p>Your cart is empty.</p>
      </div>

      <button class="back-btn" v-on:click="goBackToLessons">
        <i class="fa-solid fa-arrow-left"></i> Back to Lessons
      </button>
    </div>

    <!-- Order Confirmation -->
    <div v-else class="order-message">
      <i class="fa-solid fa-circle-check success-icon"></i>
      <h3>Thank you, {{ customer.name }}! Your order has been placed successfully.</h3>
      <button class="back-btn" v-on:click="goBackToLessons">
        <i class="fa-solid fa-house"></i> Back to Lessons
      </button>
    </div>
  </div>

</div>

<script>
  const apiURL = "http://localhost:3000";
  let app = new Vue({
  el: '#lessonStore',
  data: {
    showLessons: true,
    lessons: [],
    cart: [],
    customer: { name: '', phone: '', country: '', address: '', city: '', zip:'' },
    orderPlaced: false,
    sortBy: 'subject',
    sortOrder: 'asc',
    searchQuery: ""

  },

  created() {
    this.fetchLessons();
  },

  computed: {
    sortedLessons() {
      return this.lessons.slice().sort((a, b) => {
        let modifier = this.sortOrder === 'asc' ? 1 : -1;
        if (a[this.sortBy] < b[this.sortBy]) return -1 * modifier;
        if (a[this.sortBy] > b[this.sortBy]) return 1 * modifier;
        return 0;
      });
    },
    validName() {
    const nameRegex = /^[A-Za-z\s]+$/;
    return nameRegex.test(this.customer.name.trim());
    },
    validPhone() {
    const phoneRegex = /^[0-9]{10}$/;
    return phoneRegex.test(this.customer.phone.trim());
    },
    sortOrderIcon() {
      return this.sortOrder === 'asc' ? 'fa-solid fa-arrow-up' : 'fa-solid fa-arrow-down';
    }
  },
  methods: {
    fetchLessons() {
      fetch(`${apiURL}/lessons`)
        .then(response => response.json())
        .then(data => {
          this.lessons = data;
        })
        .catch(error => console.error("Error fetching lessons:", error));
    },

    addToCart(lesson) {
      if (lesson.spaces > 0) {
        lesson.spaces--;
        this.cart.push(JSON.parse(JSON.stringify(lesson)));
      }
    },

    toggleCart() {

        if (this.showLessons) {
            this.showLessons = false;
            this.showCart = true;
        } else {
            this.showLessons = true;
            this.showCart = false;
            this.showCheckout = false;
        }
    }, 

    goBackToLessons() {
      this.showLessons = true;
      this.orderPlaced = false;
    },
    removeFromCart(index) {
      const lesson = this.cart[index];
      const original = this.lessons.find(l => l.id === lesson.id);
      if (original) original.spaces++;
      this.cart.splice(index, 1);
    },
    toggleSortOrder() {
      this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
    },
    submitOrder() {
        if (!this.validName || !this.validPhone) return;

        const lessonIDs = this.cart.map(item => item._id);

        const orderData = {
          name: this.customer.name,
          phone: this.customer.phone,
          lessonIDs: lessonIDs,
          spaces: this.cart.length
        };

        // POST order
        fetch(`${apiURL}/orders`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(orderData)
        })
        .then(res => res.json())
        .then(data => {
          console.log("Order created:", data);

          // PUT updates for lesson spaces
          const updateRequests = this.cart.map(item => {
            return fetch(`${apiURL}/lessons/${item._id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ spaces: item.spaces })
            });
          });

          return Promise.all(updateRequests);
        })
        .then(() => {
          console.log("All lessons updated in DB");
          this.orderPlaced = true;
          this.cart = [];
          this.fetchLessons();
        })
        .catch(err => {
          console.error("Order error:", err);
          alert("There was an error placing your order.");
        });
      },

      searchLessons() {
        const q = this.searchQuery.trim();

        if (q === "") {
          this.fetchLessons();
          return;
        }

        fetch(`${apiURL}/search?query=${encodeURIComponent(q)}`)
          .then(res => res.json())
          .then(data => {
            this.lessons = data;
          })
          .catch(err => console.error("Search error:", err));
      }


  }
  });
</script>
</body>
</html>